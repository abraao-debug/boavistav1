{% extends 'materiais/base.html' %}

{% block title %}Finalizar Compra - Gestão de Obra{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-check-circle"></i> Finalizar Compra</h2>
        <p class="text-muted">Confirmar finalização da compra da SC {{ solicitacao.numero }}</p>
        <hr>
    </div>
</div>

<!-- Dados da Solicitação -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-file-alt"></i> Dados da Solicitação</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <strong>Número:</strong><br>
                <span class="badge bg-primary fs-6">{{ solicitacao.numero }}</span>
            </div>
            <div class="col-md-3">
                <strong>Solicitante:</strong><br>
                {{ solicitacao.solicitante.get_full_name|default:solicitacao.solicitante.username }}
            </div>
            <div class="col-md-3">
                <strong>Obra:</strong><br>
                {{ solicitacao.obra.nome }}
            </div>
            <div class="col-md-3">
                <strong>Data Necessidade:</strong><br>
                {{ solicitacao.data_necessidade|date:"d/m/Y" }}
            </div>
        </div>
        <div class="mt-3">
            <strong>Justificativa:</strong><br>
            {{ solicitacao.justificativa }}
        </div>
    </div>
</div>

<!-- Cotação Selecionada -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5><i class="fas fa-trophy"></i> Cotação Selecionada</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>Fornecedor:</strong><br>
                <h5>{{ cotacao_selecionada.fornecedor.nome_fantasia }}</h5>
            </div>
            <div class="col-md-3">
                <strong>Valor Total:</strong><br>
                <h4 class="text-success">R$ {{ cotacao_selecionada.valor_total|floatformat:2 }}</h4>
            </div>
            <div class="col-md-3">
                <strong>Data da Cotação:</strong><br>
                {{ cotacao_selecionada.data_cotacao|date:"d/m/Y H:i" }}
            </div>
            <div class="col-md-2">
                <strong>CNPJ:</strong><br>
                {{ cotacao_selecionada.fornecedor.cnpj }}
            </div>
        </div>
        {% if cotacao_selecionada.observacoes %}
        <div class="mt-3">
            <strong>Observações da Cotação:</strong><br>
            {{ cotacao_selecionada.observacoes }}
        </div>
        {% endif %}
    </div>
</div>

<!-- Itens da Solicitação -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Itens a Serem Comprados</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Quantidade</th>
                        <th>Unidade</th>
                        <th>Observações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in solicitacao.itens.all %}
                    <tr>
                        <td><strong>{{ item.descricao }}</strong></td>
                        <td>{{ item.quantidade }}</td>
                        <td>{{ item.unidade }}</td>
                        <td>{{ item.observacoes|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Formulário de Finalização -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-clipboard-check"></i> Confirmar Finalização</h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="observacoes_finalizacao" class="form-label">Observações da Finalização</label>
                <textarea class="form-control" id="observacoes_finalizacao" name="observacoes_finalizacao" 
                          rows="3" placeholder="Número do pedido, previsão de entrega, etc."></textarea>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Atenção:</strong> Ao finalizar a compra, a SC será marcada como "Finalizada" e ficará disponível para recebimento pelo Almoxarife da Obra.
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check-circle"></i> Finalizar Compra
                </button>
                <a href="{% url 'materiais:gerenciar_cotacoes' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}