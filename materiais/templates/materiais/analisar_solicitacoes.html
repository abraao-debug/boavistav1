{% extends 'materiais/base.html' %}
{% load static %}
{% load materiais_extras %}

{% block title %}Analisar Solicitações de Compra{% endblock %}

{% block content %}
<style>
    body {
        background-color: #f4f7fa;
    }
    .sc-card {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
    }
    .sc-header {
        padding: 1rem 1.5rem;
        background-color: rgba(0,0,0,0.02);
        border-bottom: 1px solid #e9ecef;
    }
    .sc-header h5 {
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 0;
    }
    .sc-body {
        padding: 1.5rem;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }
    .info-item strong {
        display: block;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
        text-transform: uppercase;
    }
    .actions-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.75rem; /* Aumenta o espaçamento entre os botões */
        padding-top: 1.5rem;
        margin-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    /* Cores Suaves e Botão de Destaque */
    .badge.bg-warning-soft { background-color: #fff3cd; color: #664d03; }
    .badge.bg-danger-soft { background-color: #f8d7da; color: #842029; }
    .btn-success-soft { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .btn-success-soft:hover { color: #fff; background-color: #198754; border-color: #198754; }
    .btn-danger-soft { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .btn-danger-soft:hover { color: #fff; background-color: #dc3545; border-color: #dc3545; }
    
    /* Botão de Destaque Amarelo Vivo */
    .btn-warning { 
        background-color: #ffc107; 
        border-color: #ffc107; 
        color: #000; 
    }
    .btn-warning:hover { 
        background-color: #e0a800; 
        border-color: #d39e00; 
    }
</style>

<div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mb-3">
    <div class="d-flex align-items-center mb-2 mb-sm-0">
        <a href="{% url 'materiais:dashboard' %}" class="btn btn-light border me-3">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <div>
            <h4 class="mb-0">Analisar Solicitações de Compra</h4>
            <p class="text-muted mb-0">{{ solicitacoes_pendentes.count }} solicitação{{ solicitacoes_pendentes.count|pluralize }} aguardando aprovação.</p>
        </div>
    </div>
</div>

{% if solicitacoes_pendentes %}
    {% for sc in solicitacoes_pendentes %}
    <div class="sc-card">
        <div class="sc-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="me-3">{{ sc.nome_descritivo }}</h5>
                <div>
                    <span class="badge bg-warning-soft text-dark-emphasis fw-semibold me-2">{{ sc.get_status_display }}</span>
                    {% if sc.is_emergencial %}
                        <span class="badge bg-danger-soft text-dark-emphasis fw-semibold"><i class="fas fa-exclamation-triangle"></i> URGENTE</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="sc-body">
            <div class="info-grid">
                <div class="info-item"><strong>Solicitante</strong> <span>{{ sc.solicitante.get_full_name|default:sc.solicitante.username }}</span></div>
                <div class="info-item"><strong>Obra</strong> <span>{{ sc.obra.nome }}</span></div>
                <div class="info-item"><strong>Necessário em</strong> <span><i class="fas fa-calendar-alt text-muted"></i> {{ sc.data_necessidade|date:"d/m/Y" }}</span></div>
            </div>
            {% if sc.justificativa %}
                <div class="info-item mt-3 w-100"><strong>Observações</strong> <span>{{ sc.justificativa }}</span></div>
            {% endif %}
            
            <div class="w-100">
                <hr>
                <h6 class="mb-2 text-secondary">Itens para Aprovação</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 70%;">Item</th>
                                <th class="text-center">Qtd.</th>
                                <th class="text-center">Unid.</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for item in sc.itens.all %}
                            <tr>
                                <td>{{ item.descricao }}</td>
                                <td class="text-center">{{ item.quantidade|floatformat:"-2" }}</td>
                                <td class="text-center">{{ item.unidade }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="actions-footer w-100">
                <button class="btn btn-danger-soft" onclick="abrirModalRejeicao('{{ sc.id }}', '{{ sc.numero }}')"><i class="fas fa-times"></i> Rejeitar</button>
                <a href="{% url 'materiais:analisar_editar_solicitacao' sc.id %}" class="btn btn-warning"><i class="fas fa-edit"></i> Editar e Aprovar</a>
                <button class="btn btn-success-soft" onclick="abrirModalAprovacao('{{ sc.id }}', '{{ sc.numero }}')"><i class="fas fa-check"></i> Aprovar Total</button>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="text-center p-5 bg-light rounded">
        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
        <h5>Nenhuma solicitação pendente de aprovação no momento.</h5>
    </div>
{% endif %}

<div class="modal fade" id="modalAprovar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirmar Aprovação Total</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja **aprovar totalmente** a solicitação <strong id="aprovarScNumero" class="text-primary"></strong>?
                <br><small class="text-muted">Todos os itens serão aprovados e a SC seguirá para o escritório.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarAprovacao">Sim, Aprovar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalRejeitar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-times-circle"></i> Confirmar Rejeição</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja **rejeitar** a solicitação <strong id="rejeitarScNumero" class="text-primary"></strong>? Esta ação não pode ser desfeita.</p>
                <div class="mb-3">
                    <label for="rejeitarMotivo" class="form-label">Motivo da Rejeição (Obrigatório):</label>
                    <textarea class="form-control" id="rejeitarMotivo" rows="3" placeholder="Ex: Material incorreto, quantidade excessiva, etc."></textarea>
                    <div class="invalid-feedback">O motivo da rejeição é obrigatório.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarRejeicao">Sim, Rejeitar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalAprovacaoParcial" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aprovação Parcial de Itens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBodyAprovacaoParcial"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmarAprovacaoParcial">Confirmar Aprovação dos Itens Selecionados</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
// CORREÇÃO: Definir URLs dinamicamente no Django usando um placeholder (0)
const URL_APROVAR = "{% url 'materiais:aprovar_solicitacao' 0 %}";
const URL_REJEITAR = "{% url 'materiais:rejeitar_solicitacao' 0 %}";
const URL_APROVAR_PARCIAL = "{% url 'materiais:aprovar_parcial' 0 %}";
const URL_ITENS_API = "{% url 'materiais:api_solicitacao_itens' 0 %}";


document.addEventListener('DOMContentLoaded', function() {
    let solicitacaoIdAtual = null;

    // Instâncias dos Modais
    const modalAprovar = new bootstrap.Modal(document.getElementById('modalAprovar'));
    const modalRejeitar = new bootstrap.Modal(document.getElementById('modalRejeitar'));
    const modalAprovacaoParcial = new bootstrap.Modal(document.getElementById('modalAprovacaoParcial'));
    
    // Funções para abrir os modais
    window.abrirModalAprovacao = function(id, numero) {
        solicitacaoIdAtual = id;
        document.getElementById('aprovarScNumero').textContent = numero;
        modalAprovar.show();
    };

    window.abrirModalRejeicao = function(id, numero) {
        solicitacaoIdAtual = id;
        document.getElementById('rejeitarScNumero').textContent = numero;
        const motivoInput = document.getElementById('rejeitarMotivo');
        motivoInput.value = '';
        motivoInput.classList.remove('is-invalid');
        modalRejeitar.show();
    };
    
    window.abrirModalAprovacaoParcial = function(id) {
        solicitacaoIdAtual = id;
        // CORREÇÃO: Usar a URL dinâmica para a API de itens
        fetch(URL_ITENS_API.replace('0', id))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarModalAprovacaoParcial(data.solicitacao, data.itens);
                } else {
                    alert('Erro ao carregar itens: ' + data.message);
                }
            });
    };

    // Função que renderiza o conteúdo do modal de aprovação parcial
    function mostrarModalAprovacaoParcial(solicitacao, itens) {
        const modalBody = document.getElementById('modalBodyAprovacaoParcial');
        let itensHtml = '';
        itens.forEach(item => {
            itensHtml += `
                <div class="form-check p-3 border rounded mb-2 bg-light">
                    <input class="form-check-input" type="checkbox" value="${item.id}" id="modal_item_${item.id}" name="itens_aprovados[]" checked>
                    <label class="form-check-label w-100" for="modal_item_${item.id}">
                        <strong>${item.descricao}</strong>
                        <span class="text-muted float-end">${item.quantidade} ${item.unidade}</span>
                    </label>
                </div>`;
        });
        
        modalBody.innerHTML = `
            <h6>Selecione os itens para aprovar na SC ${solicitacao.numero}:</h6>
            <p class="text-muted small">Os itens marcados abaixo serão movidos para uma nova SC aprovada.</p>
            <form id="formAprovacaoParcial">${itensHtml}
                <div class="mb-3 mt-3">
                    <label for="observacoesAprovacao" class="form-label">Observações (Opcional):</label>
                    <textarea class="form-control" id="observacoesAprovacao" name="observacoes" rows="2"></textarea>
                </div>
            </form>`;
        
        modalAprovacaoParcial.show();
    }
  
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Lógicas de Fetch para os botões de confirmação ---
    document.getElementById('btnConfirmarAprovacao').addEventListener('click', function() {
        this.disabled = true; this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Aprovando...';
        // CORREÇÃO: Usar a URL dinâmica
        const url = URL_APROVAR.replace('0', solicitacaoIdAtual);
        
        fetch(url, { 
            method: 'POST', 
            headers: { 'X-CSRFToken': getCookie('csrftoken') }, 
        }).then(r => r.json()).then(d => { 
            if (d.success) { location.reload(); } 
            else { alert('Erro: ' + d.message); this.disabled = false; this.innerHTML = 'Sim, Aprovar'; }
        });
    });

    document.getElementById('btnConfirmarRejeicao').addEventListener('click', function() {
        const motivoInput = document.getElementById('rejeitarMotivo'); 
        if (!motivoInput.value.trim()) { 
            motivoInput.classList.add('is-invalid'); 
            return; 
        }
        this.disabled = true; this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Rejeitando...';
        
        const formData = new FormData(); 
        formData.append('observacoes', motivoInput.value.trim());
        
        // CORREÇÃO: Usar a URL dinâmica
        const url = URL_REJEITAR.replace('0', solicitacaoIdAtual);

        fetch(url, { 
            method: 'POST', 
            headers: { 'X-CSRFToken': getCookie('csrftoken') }, 
            body: formData 
        }).then(r => r.json()).then(d => { 
            if (d.success) { location.reload(); } 
            else { alert('Erro: ' + d.message); this.disabled = false; this.innerHTML = 'Sim, Rejeitar'; }
        });
    });

    document.getElementById('btnConfirmarAprovacaoParcial').addEventListener('click', function() {
        const form = document.getElementById('formAprovacaoParcial');
        const checkboxes = form.querySelectorAll('input[name="itens_aprovados[]"]:checked');
        if (checkboxes.length === 0) {
            alert('Selecione pelo menos um item para aprovar!');
            return;
        }
        
        const formData = new FormData(form);
        const button = this;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Confirmando...';
        
        // CORREÇÃO: Usar a URL dinâmica
        const url = URL_APROVAR_PARCIAL.replace('0', solicitacaoIdAtual);

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
        }).then(response => response.json()).then(data => {
            if (data.success) { location.reload(); } 
            else { 
                alert('Erro: ' + data.message);
                button.disabled = false;
                button.innerHTML = 'Confirmar Aprovação dos Itens Selecionados';
            }
        });
    });
});
</script>
{% endblock %}